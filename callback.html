<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concept2 認証 - 端艇部 総合管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        h1 {
            color: #1e3a5f;
            margin-bottom: 16px;
            font-size: 1.5rem;
        }

        p {
            color: #666;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #1e3a5f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .success {
            color: #27ae60;
        }

        .error {
            color: #e74c3c;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #1e3a5f;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-top: 16px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2d5a87;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="status-icon" class="icon">⏳</div>
        <h1 id="status-title">認証処理中...</h1>
        <p id="status-message">Concept2との連携を完了しています。しばらくお待ちください。</p>
        <div id="loading" class="loading"></div>
        <a id="redirect-btn" href="index.html" class="btn" style="display: none;">アプリに戻る</a>
    </div>

    <script>
        async function processCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const returnedState = urlParams.get('state');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');

            const iconEl = document.getElementById('status-icon');
            const titleEl = document.getElementById('status-title');
            const messageEl = document.getElementById('status-message');
            const loadingEl = document.getElementById('loading');
            const redirectBtn = document.getElementById('redirect-btn');

            // エラーチェック
            if (error) {
                iconEl.textContent = '❌';
                titleEl.textContent = '認証エラー';
                titleEl.classList.add('error');
                messageEl.textContent = errorDescription || error;
                loadingEl.style.display = 'none';
                redirectBtn.style.display = 'inline-block';
                return;
            }

            // 認証コードがない場合
            if (!code) {
                iconEl.textContent = '❓';
                titleEl.textContent = '認証情報がありません';
                messageEl.textContent = 'このページには直接アクセスできません。';
                loadingEl.style.display = 'none';
                redirectBtn.style.display = 'inline-block';
                return;
            }

            // 状態トークンを検証
            const savedState = localStorage.getItem('concept2_oauth_state');
            if (returnedState !== savedState) {
                iconEl.textContent = '⚠️';
                titleEl.textContent = 'セキュリティエラー';
                titleEl.classList.add('error');
                messageEl.textContent = '認証状態が一致しません。もう一度お試しください。';
                loadingEl.style.display = 'none';
                redirectBtn.style.display = 'inline-block';
                return;
            }

            // 保存されたクライアント情報を取得
            const clientId = localStorage.getItem('concept2_pending_client_id');
            // const clientSecret = localStorage.getItem('concept2_pending_client_secret'); // 不要
            const userId = localStorage.getItem('concept2_pending_user_id');

            if (!clientId) {
                iconEl.textContent = '⚠️';
                titleEl.textContent = '設定エラー';
                messageEl.textContent = 'クライアント情報が見つかりません。再度連携を試してください。';
                loadingEl.style.display = 'none';
                redirectBtn.style.display = 'inline-block';
                return;
            }

            try {
                // Supabase Edge FunctionのURLを取得
                // supabase-client.jsから設定を読み込む
                let edgeFunctionUrl = 'http://localhost:54321/functions/v1';

                // supabase-client.jsの設定を使用（存在する場合）
                if (typeof window.SupabaseClient !== 'undefined' && window.SupabaseClient.supabaseUrl) {
                    edgeFunctionUrl = window.SupabaseClient.supabaseUrl.replace('.supabase.co', '.supabase.co/functions/v1');
                }

                messageEl.textContent = 'トークンを取得中...';

                // リダイレクトURI
                const redirectUri = window.location.origin + window.location.pathname;

                // Edge Functionを呼び出してトークン交換
                const response = await fetch(edgeFunctionUrl + '/concept2-auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        redirect_uri: redirectUri,
                        user_id: userId,
                    }),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'トークン交換に失敗しました');
                }

                // 成功 - LocalStorageに結果を保存
                const authResult = {
                    success: true,
                    access_token: result.access_token,
                    refresh_token: result.refresh_token,
                    expires_in: result.expires_in,
                    client_id: clientId,
                    user_id: userId,
                    timestamp: Date.now()
                };
                localStorage.setItem('concept2_auth_result', JSON.stringify(authResult));

                // 一時データをクリア
                localStorage.removeItem('concept2_pending_client_id');
                // Client Secretはローカルに保存しない
                localStorage.removeItem('concept2_pending_user_id');
                localStorage.removeItem('concept2_oauth_state');

                iconEl.textContent = '✅';
                titleEl.textContent = '認証成功！';
                titleEl.classList.add('success');
                messageEl.textContent = 'Concept2との連携が完了しました。アプリに戻ります...';
                loadingEl.style.display = 'none';

                // 2秒後にメインアプリにリダイレクト
                setTimeout(() => {
                    window.location.href = 'index.html?concept2_auth=success';
                }, 2000);

            } catch (error) {
                console.error('Token exchange error:', error);
                iconEl.textContent = '❌';
                titleEl.textContent = '認証エラー';
                titleEl.classList.add('error');
                messageEl.textContent = error.message;
                loadingEl.style.display = 'none';
                redirectBtn.style.display = 'inline-block';
            }
        }

        // ページ読み込み時に実行
        processCallback();
    </script>
</body>

</html>